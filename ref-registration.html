<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ref-registration">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Cluster Registration Internals | Fleet</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://fleet.rancher.io/ref-registration"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Cluster Registration Internals | Fleet"><meta data-rh="true" name="description" content="How does cluster registration work?"><meta data-rh="true" property="og:description" content="How does cluster registration work?"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://fleet.rancher.io/ref-registration"><link data-rh="true" rel="alternate" href="https://fleet.rancher.io/ref-registration" hreflang="en"><link data-rh="true" rel="alternate" href="https://fleet.rancher.io/ref-registration" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://5YEVIM7OXD-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Fleet" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.d6ff17f5.css">
<link rel="preload" href="/assets/js/runtime~main.e499a711.js" as="script">
<link rel="preload" href="/assets/js/main.4d39d17f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Fleet</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/">Next ðŸš§</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/ref-registration">Next ðŸš§</a></li><li><a class="dropdown__link" href="/0.9/ref-registration">0.9</a></li><li><a class="dropdown__link" href="/0.8/ref-registration">0.8</a></li><li><a class="dropdown__link" href="/0.7/ref-registration">0.7</a></li><li><a class="dropdown__link" href="/0.6/ref-registration">0.6</a></li><li><a class="dropdown__link" href="/0.5">0.5</a></li><li><a class="dropdown__link" href="/0.4">0.4</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__docs navbar__link--active" href="/">Docs</a><a href="https://github.com/rancher/fleet" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://rancher-users.slack.com/channels/fleet" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-slack-link" aria-label="Slack Channel"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">More from SUSE</a><ul class="dropdown__menu"><li><a href="https://www.rancher.com" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__rancher">Rancher<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><hr style="margin: 0.3rem 0;"></li><li><a href="https://elemental.docs.rancher.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__elemental">Elemental<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://harvesterhci.io" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__harvester">Harvester<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://rancherdesktop.io" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__rd">Rancher Desktop<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><hr style="margin: 0.3rem 0;"></li><li><a href="https://opensource.suse.com" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__suse">More Projects...<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/quickstart">Tutorials</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/quickstart">Quick Start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tut-deployment">Creating a Deployment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/uninstall">Uninstall</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/architecture">Explanations</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts">Core Concepts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ref-bundle-stages">Bundle Lifecycle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/gitrepo-content">Git Repository Contents</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/namespaces">Namespaces</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/resources-during-deployment">Custom Resources During Deployment</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/installation">How-tos for Operators</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/installation">Installation Details</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cluster-registration">Register Downstream Clusters</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cluster-group">Create Cluster Groups</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/multi-user">Setup Multi User</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/gitrepo-add">How-tos for Users</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/gitrepo-add">Create a GitRepo Resource</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/gitrepo-targets">Mapping to Downstream Clusters</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/bundle-diffs">Generating Diffs to Ignore Modified GitRepos</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/webhook">Using Webhooks Instead of Polling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/imagescan">Using Image Scan to Update Container Image References</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/bundle-add">Create a Bundle Resource</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/cli/fleet-agent">Reference</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/cli/fleet-agent">CLI</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cluster-bundles-state">Cluster and Bundle State</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ref-registration">Cluster Registration Internals</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ref-configuration">Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ref-resources">List of Deployed Resources</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ref-crds">Custom Resources Spec</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ref-fleet-yaml">fleet.yaml</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ref-gitrepo">GitRepo Resource</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ref-bundle">Bundle Resource</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/troubleshooting">Troubleshooting</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/changelogs/changelogs/next">Changelog</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Reference</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Cluster Registration Internals</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: Next ðŸš§</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Cluster Registration Internals</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-does-cluster-registration-work">How does cluster registration work?<a href="#how-does-cluster-registration-work" class="hash-link" aria-label="Direct link to How does cluster registration work?" title="Direct link to How does cluster registration work?">â€‹</a></h2><p>This text describes cluster registration with more technical details. The text ignores agent initiated registration, as itâ€™s not commonly used.
<a href="/cluster-registration#agent-initiated">Agent initiated registration</a> is <a href="/cluster-registration#create-cluster-registration-tokens">&quot;<code>ClusterRegistrationToken</code> first&quot;</a>, which means pre-creating a cluster is optional.</p><p>See &quot;<a href="/cluster-registration">Register Downstream Clusters</a>&quot; to learn how to register clusters.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cluster-first">Cluster first<a href="#cluster-first" class="hash-link" aria-label="Direct link to Cluster first" title="Direct link to Cluster first">â€‹</a></h3><p><code>fleet-controller</code> starts up and may &quot;bootstrap&quot; the local cluster resource. In Rancher creating the local cluster resource is handled by the fleetcluster controller instead, but otherwise the process is identical.</p><p>The process is identical for the local cluster or any downstream cluster. It starts by  creating a cluster resource, which refers to a kubeconfig secret.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-the-bootstrap-secret-for-the-downstream-cluster">Creating the Bootstrap Secret for the Downstream Cluster<a href="#creating-the-bootstrap-secret-for-the-downstream-cluster" class="hash-link" aria-label="Direct link to Creating the Bootstrap Secret for the Downstream Cluster" title="Direct link to Creating the Bootstrap Secret for the Downstream Cluster">â€‹</a></h3><p>In this step a <code>ClusterRegistationToken</code> and an &quot;import&quot; service account are created based on a <code>Cluster</code> resource.</p><p>The Fleet controller creates a <a href="https://fleet.rancher.io/architecture#security" target="_blank" rel="noopener noreferrer"><code>ClusterRegistrationToken</code></a>
and waits for it to be complete. The <code>ClusterRegistationToken</code> triggers the creation of the &quot;import&quot; service account, which can create
<code>ClusterRegistrations</code> and read any secret in the system registration namespace (eg &quot;cattle-fleet-clusters-system&quot;). The <code>import.go</code> controller will
enqueue itself until the &quot;import&quot; service account exists, because that account is needed to create the <code>fleet-agent-bootstrap</code> secret.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-the-fleet-agent-deployment">Creating the Fleet Agent Deployment<a href="#creating-the-fleet-agent-deployment" class="hash-link" aria-label="Direct link to Creating the Fleet Agent Deployment" title="Direct link to Creating the Fleet Agent Deployment">â€‹</a></h3><p>The Fleet controller will now create the Fleet agent deployment and the bootstrap secret on the downstream cluster.</p><p>The bootstrap secret contains the API server URL of the upstream cluster and is used to build a kubeconfig to access the upstream cluster. Both values are taken from the Fleet controller config configmap. That configmap is part of the helm chart.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fleet-agent-starts-registration-upgrades-to-request-account">Fleet Agent Starts Registration, Upgrades to Request Account<a href="#fleet-agent-starts-registration-upgrades-to-request-account" class="hash-link" aria-label="Direct link to Fleet Agent Starts Registration, Upgrades to Request Account" title="Direct link to Fleet Agent Starts Registration, Upgrades to Request Account">â€‹</a></h3><p>The agent uses the &quot;import&quot; account to upgrade to a request account.</p><p>Immediately the Fleet agent checks for a <code>fleet-agent-bootstrap</code> secret. If the bootstrap secret, which contains the &quot;import&quot; kubeconfig, is present the agent starts registering.</p><p>Then agent creates the final <code>ClusterRegistration</code> resource in fleet-default on the management cluster, with a random number. The random number will be used for the registration secret&#x27;s name.</p><p>The Fleet controller triggers and tries to grant the <code>ClusterRegistration</code> request to create agent&#x27;s service account and create the &#x27;c-<!-- -->*<!-- -->&#x27; registration secret with the client&#x27;s new kubeconfig. The registration secret name is <code>hash(&quot;clientID-clientRandom&quot;)</code>.</p><p>The new kubeconfig uses the &quot;request&quot; account. The &quot;request&quot; account can access the cluster status, <code>BundleDeployments</code> and <code>Contents</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fleet-agent-is-registered-watches-for-bundledeployments">Fleet Agent is Registered, Watches for <code>BundleDeployments</code><a href="#fleet-agent-is-registered-watches-for-bundledeployments" class="hash-link" aria-label="Direct link to fleet-agent-is-registered-watches-for-bundledeployments" title="Direct link to fleet-agent-is-registered-watches-for-bundledeployments">â€‹</a></h3><p>At this point the agent is fully registered and will persist the &quot;request&quot; account into a <code>fleet-agent</code> secret.
The API server URL and CA are copied from the bootstrap secret, which inherited these values from the Fleet controller&#x27;s helm chart values.</p><p>The bootstrap secret is deleted. When the agent restarts, it will not re-register, since the bootstrap secret is missing.</p><p>The agent starts watching its &quot;<a href="https://fleet.rancher.io/namespaces#cluster-namespaces" target="_blank" rel="noopener noreferrer">Cluster Namespace</a>&quot; for <code>BundleDeployments</code>. At this point the agent is ready to deploy workloads.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">â€‹</a></h3><ul><li>The registration starts with the &quot;import&quot; account and pivots to the &quot;request&quot; account.</li><li>The fleet-default namespace has all the cluster registrations, the &quot;import&quot; account uses a separate namespace.</li><li>Once the agent is registered, <code>fleet-controller</code> will trigger on a cluster or namespace change. The <code>manageagent</code> controller will then create a bundle to adopt the existing agent deployment. The agent will update itself to the bundle and since the &quot;generation&quot; environment variable changes, it will restart.</li><li>If no bootstrap secret exists, the agent will not re-register.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="diagram">Diagram<a href="#diagram" class="hash-link" aria-label="Direct link to Diagram" title="Direct link to Diagram">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="registration-process-and-controllers">Registration Process and Controllers<a href="#registration-process-and-controllers" class="hash-link" aria-label="Direct link to Registration Process and Controllers" title="Direct link to Registration Process and Controllers">â€‹</a></h3><p>Detailed analysis of the registration process for clusters. This shows the interaction of controllers, resources and service accounts during the registration of a new downstream cluster or the local cluster.</p><p>It is important to note that there are multiple ways to start this:</p><ul><li>Creating a bootstrap config. Fleet does this for the local agent.</li><li>Creating a <code>Cluster</code> resource with a kubeconfig. Rancher does this for downstream clusters. See <a href="/cluster-registration#manager-initiated">manager-initiated registration</a>.</li><li>Create a <code>ClusterRegistrationToken</code> resource, optionally create a <code>Cluster</code> resource for a pre-defined (<code>clientID</code>) cluster. See <a href="/cluster-registration#agent-initiated">agent-initiated registration</a>.</li></ul><p><img loading="lazy" alt="Registration" src="/assets/images/FleetRegistration-e49565723b02880b6dd7fa0ddc1fdbe2.svg" width="3700" height="2492" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="secrets-during-agent-deployment">Secrets during Agent Deployment<a href="#secrets-during-agent-deployment" class="hash-link" aria-label="Direct link to Secrets during Agent Deployment" title="Direct link to Secrets during Agent Deployment">â€‹</a></h3><p>This diagram shows the resources created during registration and focuses on the k8s API server configuration.</p><p>The <code>import.go</code> controller triggers on Cluster creation/update events and deploys the agent.</p><p><strong>This image shows how the API server URL and CA propagates through the secrets during registration:</strong></p><p>The arrows in the diagram show how the API server values are copied from
the Helm values to the cluster registration secret on the upstream
cluster and finally downstream to the bootstrap secret of the agent.</p><p>There is one special case, if the agent is for the local/&quot;bootstrap&quot;
cluster, the server values also exist in the kubeconfig secret,
referenced by the Cluster resource. In this case the kubeconfig secret
contains the upstream server URL and CA, next to the downstream&#x27;s
kubeconfig. If the settings are present in the kubeconfig secret, they
override the configured values.</p><p><img loading="lazy" alt="Registration Secrets" src="/assets/images/FleetRegistrationSecrets-deae20b127f82ebcf32a5c593b53b912.svg" width="1581" height="4162" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fleet-cluster-registration-in-rancher">Fleet Cluster Registration in Rancher<a href="#fleet-cluster-registration-in-rancher" class="hash-link" aria-label="Direct link to Fleet Cluster Registration in Rancher" title="Direct link to Fleet Cluster Registration in Rancher">â€‹</a></h2><p>Rancher installs the fleet helm chart. The API server URL and CA are <a href="https://github.com/rancher/rancher/blob/release/v2.9/pkg/controllers/dashboard/fleetcharts/controller.go#L111-L112" target="_blank" rel="noopener noreferrer">derived from Rancher&#x27;s settings</a>.</p><p>Fleet will pass these values to a Fleet agent, so it can connect back to the Fleet controller.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="import-cluster-into-rancher">Import Cluster into Rancher<a href="#import-cluster-into-rancher" class="hash-link" aria-label="Direct link to Import Cluster into Rancher" title="Direct link to Import Cluster into Rancher">â€‹</a></h3><p>When the user runs <code>curl | kubectl apply</code>, the applied manifest includes the rancher agent deployment.</p><p>The deployment contains a secret <code>cattle-credentials-</code> which contains the API URL and a token.</p><p>The Rancher agent starts up and reports downstream&#x27;s kubeconfig to upstream.</p><p>Rancher then creates the fleet Cluster resource, which references a <a href="https://github.com/rancher/rancher/blob/871b6d9137246bd93733f01184ea435f40c5d56c/pkg/provisioningv2/kubeconfig/manager.go#L69" target="_blank" rel="noopener noreferrer">kubeconfig secret</a>.</p><p>ðŸ‘‰Fleet will use this kubeconfig to deploy the agent on the downstream cluster.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/rancher/fleet-docs/edit/main/docs/ref-registration.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2024-06-21T12:58:50.000Z">Jun 21, 2024</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/cluster-bundles-state"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Cluster and Bundle State</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ref-configuration"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Configuration</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#how-does-cluster-registration-work" class="table-of-contents__link toc-highlight">How does cluster registration work?</a><ul><li><a href="#cluster-first" class="table-of-contents__link toc-highlight">Cluster first</a></li><li><a href="#creating-the-bootstrap-secret-for-the-downstream-cluster" class="table-of-contents__link toc-highlight">Creating the Bootstrap Secret for the Downstream Cluster</a></li><li><a href="#creating-the-fleet-agent-deployment" class="table-of-contents__link toc-highlight">Creating the Fleet Agent Deployment</a></li><li><a href="#fleet-agent-starts-registration-upgrades-to-request-account" class="table-of-contents__link toc-highlight">Fleet Agent Starts Registration, Upgrades to Request Account</a></li><li><a href="#fleet-agent-is-registered-watches-for-bundledeployments" class="table-of-contents__link toc-highlight">Fleet Agent is Registered, Watches for <code>BundleDeployments</code></a></li><li><a href="#notes" class="table-of-contents__link toc-highlight">Notes</a></li></ul></li><li><a href="#diagram" class="table-of-contents__link toc-highlight">Diagram</a><ul><li><a href="#registration-process-and-controllers" class="table-of-contents__link toc-highlight">Registration Process and Controllers</a></li><li><a href="#secrets-during-agent-deployment" class="table-of-contents__link toc-highlight">Secrets during Agent Deployment</a></li></ul></li><li><a href="#fleet-cluster-registration-in-rancher" class="table-of-contents__link toc-highlight">Fleet Cluster Registration in Rancher</a><ul><li><a href="#import-cluster-into-rancher" class="table-of-contents__link toc-highlight">Import Cluster into Rancher</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024 SUSE Rancher. All Rights Reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e499a711.js"></script>
<script src="/assets/js/main.4d39d17f.js"></script>
</body>
</html>